<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Static Code Analyzer — Report</title>
    <style>
        :root {
            --bg: #0b0e1a; 
            --card: #141a28; 
            --glass: rgba(255, 255, 255, 0.04);
            --muted: #98a3b8;
            --accent1: #7c3aed;
            --accent2: #06b6d4;
            --accent3: #f97316;
            --success: #10b981;
            --danger: #ef4444;
            --glass-border: rgba(255, 255, 255, 0.08); 
            --green: #10b981;
            --blue: #06b6d4;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            color: #e6eef8;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
            background-color: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }
        
        .hidden {
            display: none !important;
        }

        .app-container {
            position: relative;
            z-index: 1;
            padding: 24px;
            height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 16px; 
            max-width: 1200px; 
            width: 100%;
            height: calc(100vh - 48px); 
            margin: 0 auto;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .intro-card, .pre-report-card {
            background: rgba(20, 26, 40, 0.7);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(8px);
            padding: 32px; 
            border-radius: 16px;
            text-align: center;
            width: 450px; 
            max-width: 90%;
            animation: fadeIn 0.8s forwards;
        }

        .pre-report-card h2 {
            margin-top: 0;
        }

        .pre-report-card .pulse-ring {
            width: 50px; 
            height: 50px;
            border-radius: 50%;
            border: 4px solid var(--accent1);
            position: relative;
            margin: 16px auto; 
        }

        .pre-report-card .pulse-ring::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 4px solid transparent;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-out;
            border-color: var(--accent2);
        }

        @keyframes pulse {
            0% { transform: scale(0.6); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.3; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        .progress-bar-container {
            width: 80%;
            height: 10px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 5px;
            margin: 16px auto 0; 
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            transition: width 0.3s ease-in-out;
            border-radius: 5px;
        }

        .progress-text {
            margin-top: 8px; 
            font-size: 14px;
            color: var(--muted);
        }
        
        .file-input-label {
            display: block;
            background: rgba(255, 255, 255, 0.08);
            padding: 10px; 
            border-radius: 10px;
            margin-bottom: 16px; 
            cursor: pointer;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .file-input-label:hover {
            border-color: var(--accent2);
            background: rgba(255, 255, 255, 0.1);
        }

        .file-input-label span {
            display: block;
            font-weight: 600;
        }
        
        .panel {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 16px; 
            border-radius: 14px;
        }

        .sidebar {
            height: 100%;
            position: sticky;
            top: 0;
            overflow-y: auto; 
            padding: 16px; 
            display: flex;
            flex-direction: column;
        }
        
        .project-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-title h2 {
            margin: 0;
            font-size: 18px;
        }

        .meta {
            color: var(--muted);
            font-size: 13px;
            margin-top: 4px; 
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-top: 12px; 
        }
        
        .action-controls {
            display: flex;
            gap: 8px;
            margin-top: auto; 
            padding-top: 16px; 
            border-top: 1px solid rgba(255, 255, 255, 0.04);
        }
        
        .action-controls .btn {
            flex: 1; 
        }
        
        .action-btn {
            background: linear-gradient(135deg, var(--green), var(--blue));
            border: none;
            color: #030312;
            font-weight: 700;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--blue), var(--green)); 
        }


        .btn {
            padding: 8px 10px; 
            border-radius: 8px; 
            border: 1px solid transparent;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            cursor: pointer;
            font-weight: 600;
            color: inherit;
        }

        .btn.primary {
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            color: #030312
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px; 
            margin-top: 12px; 
        }

        .card {
            padding: 12px; 
            border-radius: 10px; 
            display: flex;
            align-items: center;
            gap: 10px; 
            background: rgba(255, 255, 255, 0.03); 
        }

        .card .big {
            font-size: 18px; 
            font-weight: 700
        }

        .sev {
            width: 40px; 
            height: 40px;
            border-radius: 8px; 
            display: grid;
            place-items: center;
            font-weight: 700
        }

        .sev.low {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.06));
            color: var(--success)
        }

        .sev.med {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.12), rgba(249, 115, 22, 0.06));
            color: var(--accent3)
        }

        .sev.high {
            background: linear-gradient(135deg, rgba(244, 63, 36, 0.12), rgba(244, 63, 36, 0.06));
            color: var(--danger)
        }

        .sev.crit {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.12), rgba(124, 58, 237, 0.06));
            color: var(--accent1)
        }

        .main {
            height: 100%;
            min-height: 70vh;
            padding: 16px; 
            position: relative;
            overflow-y: auto; 
        }

        .filters {
            display: flex;
            gap: 10px; 
            align-items: center
        }

        .search {
            flex: 1;
            padding: 8px 10px; 
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: inherit
        }

        .results {
            margin-top: 16px; 
            display: grid;
            gap: 10px; 
        }

        .finding {
            display: flex;
            justify-content: space-between;
            gap: 10px; 
            padding: 12px; 
            border-radius: 10px;
            align-items: center;
            border: 1px solid transparent;
            backdrop-filter: blur(6px);
            background: rgba(255, 255, 255, 0.02); 
            transform: translateY(12px);
            opacity: 0;
            animation: fadeInUp .6s forwards
        }

        .finding .left {
            display: flex;
            gap: 10px; 
            align-items: center
        }

        .finding .code-preview {
            font-family: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 8px; 
            border-radius: 6px;
            font-size: 12px; 
        }

        .finding .meta {
            color: var(--muted);
            font-size: 12px;
        }

        @keyframes fadeInUp {
            to {
                transform: none;
                opacity: 1
            }
        }

        .detail-overlay,
        #suggestFixOverlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 50;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            transition: all 0.4s ease;
        }
        
        .detail-overlay.open,
        #suggestFixOverlay.open {
             pointer-events: auto;
        }

        .detail {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 46%;
            height: 70%;
            background: transparent;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%) scale(0.8) translateY(-20px);
            opacity: 0;
            transition: all .36s cubic-bezier(.2, .9, .2, 1);
            overflow: hidden;
            z-index: 51;
        }

        .detail.open {
            transform: translate(-50%, -50%) scale(1) translateY(0);
            opacity: 1;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .detail-body {
            padding: 12px; 
            height: calc(100% - 48px);
            overflow: auto;
        }
        
    
        .grain {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: radial-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 3px 3px;
            opacity: 0.12;
            z-index: 2; 
        }

        .lines {
            position: absolute;
            inset: 0;
            mask-image: linear-gradient(transparent, rgba(0, 0, 0, 0.14));
            pointer-events: none;
            z-index: 10;
        }

        .lines:before {
            content: '';
            position: absolute;
            inset: -10% 0;
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0.01), transparent 20%, rgba(255, 255, 255, 0.01));
            transform: skewX(-8deg);
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85rem;
            color: white;
            text-transform: capitalize;
            box-shadow: 0 0 6px rgba(0,0,0,0.3);
            }

            /* Severity colors */
            .pill.critical {
            color: #fa0000;
            }

            .pill.high {
            color: #ff4d00; 
            }

            .pill.medium {
            color: #ffc400; 
            }

            .pill.easy {
            color: #ADD8E6 ;
            }


        .tag {
            font-size: 11px; 
            padding: 4px 6px; 
            border-radius: 6px
        }

        .share-btn {
            display: block;
            width: 100%;
            margin-top: 16px; 
            text-align: center;
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            color: #030312;
            padding: 10px; 
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        @media(max-width:1000px) {
            .report-grid {
                grid-template-columns: 1fr;
            }

            .detail {
                position: fixed;
                left: 6%;
                right: 6%;
                top: 12%;
                width: auto;
                height: 70%
            }
        }
    </style>
</head>
<body>
    <div id="vanta-bg"></div>

    <div class="grain"></div>
    <div class="lines"></div>
    
    <!-- Intro Screen -->
    <div class="app-container" id="intro">
        <div class="intro-card">
            <h1 style="margin:0;font-size:2rem;background:linear-gradient(90deg, var(--accent1), var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Code Analyzer</h1>
            <p class="meta" style="margin-top:8px">Select your files to begin the static code analysis.</p>
            <div style="margin-top:24px"> 
                <label for="file-input" class="file-input-label">
                    <span>Choose file...</span>
                    <p style="margin:4px 0 0;font-size:12px;color:var(--muted)" id="file-name">No files selected</p>
                </label>
                <input type="file" id="file-input" multiple style="display:none;" />
            </div>
            <button class="btn primary" style="width:100%;margin-top:16px" onclick="startScan()" disabled id="start-scan-btn">Start Scan</button>
        </div>
    </div>
    
    <!-- Pre-Report Screen with animation -->
    <div class="app-container hidden" id="preReport">
        <div class="pre-report-card">
            <h2 style="font-size:1.5rem">Analyzing Codebase...</h2>
            <div class="pulse-ring"></div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p class="progress-text" id="progressText">Initializing scan...</p>
        </div>
    </div>

    <!-- Main Report UI -->
    <div class="app-container hidden" id="app">
        <div class="report-grid">
            <aside class="sidebar panel">
                <div class="project-title">
                    <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:grid;place-items:center;font-weight:800">A</div>
                    <div>
                        <h2 id="projectName">Project: SecureGov</h2>
                        <div class="meta">Last scanned: <strong id="last-scanned">Aug 8, 2025</strong></div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="exportJSON()">Export JSON</button>
                    <button class="btn" onclick="copySummary()">Copy</button>
                </div>

                <div class="summary">
                    <div class="card">
                        <div class="sev low">L</div>
                        <div>
                            <div class="big" id="lowCount">12</div>
                            <div class="meta">Low severity</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="sev med">M</div>
                        <div>
                            <div class="big" id="medCount">8</div>
                            <div class="meta">Medium severity</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="sev high">H</div>
                        <div>
                            <div class="big" id="highCount">4</div>
                            <div class="meta">High severity</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="sev crit">C</div>
                        <div>
                            <div class="big" id="critCount">2</div>
                            <div class="meta">Critical</div>
                        </div>
                    </div>
                </div>

                <button class="share-btn" onclick="showOutro()">Share Report</button>

                <div style="margin-top:16px"> 
                    <div class="pill">Language: Python, JS</div>
                    <div style="margin-top:8px;color:var(--muted);font-size:13px">Tags</div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"> 
                        <div class="tag" style="background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.04));">Security</div>
                        <div class="tag" style="background:linear-gradient(90deg, rgba(249,115,22,0.12), rgba(124,58,237,0.02));">Performance</div>
                        <div class="tag" style="background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(6,182,212,0.02));">Style</div>
                    </div>
                </div>
                
                <div class="action-controls">
                    <button class="btn action-btn" id="restart-analysis-btn" onclick="restartScan()">0x-Restart</button>
                </div>

            </aside>

            <main class="main panel">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h3 style="margin:0">Analysis Report</h3>
                    <div class="filters">
                        <input class="search" placeholder="Search issues, filenames, rules..." id="search" oninput="renderResults()">
                        <div style="display:flex;gap:8px">
                            <button class="btn" onclick="setFilter('all')">All</button>
                            <button class="btn" onclick="setFilter('low')">Low</button>
                            <button class="btn" onclick="setFilter('medium')">Medium</button>
                            <button class="btn" onclick="setFilter('high')">High</button>
                            <button class="btn" onclick="setFilter('critical')">Critical</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid rgba(255,255,255,0.2);border-radius:10px">
                    <div>
                        <div style="font-size:13px;color:var(--muted)">Total Issues</div>
                        <div style="font-size:20px;font-weight:800" id="totalIssues">0</div>
                    </div>
                    <div>
                        <div style="font-size:13px;color:var(--muted)">Confidence</div>
                        <div id="riskScore" style="font-size:20px;font-weight:700;color:var(--accent2)">0%</div>
                    </div>
                </div>

                <section class="results" id="results"></section>

            </main>
        </div>
    </div>

    <div class="detail-overlay" id="detailOverlay">
        <div class="detail" id="detailPanel">
            <div class="detail-header">
                <div>
                    <div style="font-weight:800" id="detailTitle">Issue Title</div>
                    <div class="meta" id="detailMeta">file.py:120 • High • rule:SQL-Injection</div>
                    <div id="detailSeverity"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <span class="pill critical">Critical</span>
                    <span class="pill high">High</span>
                    <span class="pill medium">Medium</span>
                    <span class="pill easy">Easy</span>
                    <button class="btn" onclick="closeDetail()">Close</button>
                </div>
            </div>
            <div class="detail-body">
                <h4>Summary</h4>
                <p id="detailSummary" style="color:var(--muted)">This is a placeholder for the issue summary explaining why the pattern is flagged and quick remediation steps.</p>

                <h4 style="margin-top:12px">Code</h4>
                <pre id="detailCode" style="background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;overflow:auto;color:#e6eef8;font-size:13px"></pre>

                <h4 style="margin-top:12px">Suggested Fix</h4>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="btn" onclick="copyFix()">Copy Fix</button>
                </div>

            </div>
        </div>
    </div>

    <div class="detail-overlay" id="suggestFixOverlay">
        <div class="detail" id="suggestFixPanel">
            <div class="detail-header">
                <div>
                    <div style="font-weight:800">AI Suggested Fix</div>
                    <div class="meta" id="fixMeta"></div>
                </div>
                <button class="btn" onclick="closeSuggestFix()">Close</button>
            </div>
            <div class="detail-body">
                <h4>Proposed Code Change</h4>
                <p style="color:var(--muted)">Here is a potential fix generated by AI to resolve the issue. Please review and test thoroughly before applying.</p>
                <pre id="suggestedFixCode" 
                        style="background:rgba(0,0,0,0.25);
                                padding:12px;
                                border-radius:8px;
                                overflow:auto;
                                color:#e6eef8;
                                font-size:13px;
                                white-space:pre-wrap;
                                word-break:break-word;"></pre>

                    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
                    <button class="btn" onclick="copySuggestedFix()">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    <script>
  // Vanta.js Initialization
  VANTA.GLOBE({
    el: "#vanta-bg",
    mouseControls: true,
    touchControls: true,
    gyroControls: false,
    minHeight: 200.00,
    minWidth: 200.00,
    scale: 1.00,
    scaleMobile: 1.00,
    color: 0x7c3aed,
    color2: 0x06b6d4,
    size: 0.9,
    backgroundColor: 0x0b0e1a,
  });

  // Global variables
  let findings = [];
  let currentFilter = 'all';
  let fileName = 'No files selected';

  // Declare variables to hold DOM elements; will assign inside window.onload
  let introScreen, preReportScreen, appScreen, fileInput, fileNameDisplay, startScanBtn, projectNameDisplay, progressBar, progressText;

  window.onload = () => {
    // Assign DOM elements after document fully loaded
    introScreen = document.getElementById('intro');
    preReportScreen = document.getElementById('preReport');
    appScreen = document.getElementById('app');
    fileInput = document.getElementById('file-input');
    fileNameDisplay = document.getElementById('file-name');
    startScanBtn = document.getElementById('start-scan-btn');
    projectNameDisplay = document.getElementById('projectName');
    progressBar = document.getElementById('progressBar');
    progressText = document.getElementById('progressText');

    // Defensive check for required elements
    if (!startScanBtn || !fileInput || !introScreen || !preReportScreen || !appScreen) {
      console.error("One or more required DOM elements are missing.");
      return;
    }

    // Disable scan button initially — force user to select a file first
    startScanBtn.disabled = true;

    // Show intro screen initially
    showIntro();

    // File input change event
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        fileName = Array.from(fileInput.files).map(f => f.name).join(', ');
        fileNameDisplay.textContent = fileName;
        startScanBtn.disabled = false;
      } else {
        fileName = 'No files selected';
        fileNameDisplay.textContent = fileName;
        startScanBtn.disabled = true;
      }
    });

    // Scan button click event — prevent default if inside a form
    startScanBtn.addEventListener('click', e => {
      e.preventDefault();
      console.log("Files at scan start:", fileInput.files);
      startScan();
    });
  };

  // UI state management functions

  function showIntro() {
    introScreen.classList.remove('hidden');
    preReportScreen.classList.add('hidden');
    appScreen.classList.add('hidden');
  }

  async function startScan() {
    introScreen.classList.add('hidden');
    preReportScreen.classList.remove('hidden');
    animateScan();

    try {
      findings = await fetchScanReport();
      if (!Array.isArray(findings) || findings.length === 0) {
        progressText.textContent = "No issues found or no data received.";
        setTimeout(() => showIntro(), 2000);
        return;
      }
      setTimeout(() => {
        showReport(findings);
      }, 500);
    } catch (e) {
      console.error("Failed to fetch scan report:", e);
      progressText.textContent = "Scan failed. Please try again.";
      setTimeout(() => showIntro(), 2000);
    }
  }

  async function fetchScanReport() {
    if (fileInput.files.length === 0) {
      throw new Error("No file selected");
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    console.log("FormData file:", formData.get('file'));

    try {
      const response = await fetch('/scan', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error(`Scan failed: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('Scan results:', data);
      return data;
    } catch (error) {
      console.error('Error during scan:', error);
      throw error;
    }
  }

  function showReport(reportData) {
    preReportScreen.classList.add('hidden');
    appScreen.classList.remove('hidden');
    projectNameDisplay.textContent = `Project: ${fileName}`;
    document.getElementById('last-scanned').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

    updateSummaryCounts(reportData);
    renderResults();
  }

  function updateSummaryCounts(reportData) {
    document.getElementById('lowCount').textContent = reportData.filter(f => f.severity === 'low').length;
    document.getElementById('medCount').textContent = reportData.filter(f => f.severity === 'medium').length;
    document.getElementById('highCount').textContent = reportData.filter(f => f.severity === 'high').length;
    document.getElementById('critCount').textContent = reportData.filter(f => f.severity === 'critical').length;
    document.getElementById('totalIssues').textContent = reportData.length;
  }

  function animateScan() {
    let progress = 0;
    const scanMessages = [
      "Initializing analysis...",
      "Scanning files for patterns...",
      "Checking for security vulnerabilities...",
      "Detecting code quality issues...",
      "Compiling report data...",
      "Finalizing report...",
      "Scan complete!"
    ];
    const totalSteps = scanMessages.length;
    let currentStep = 0;
    const interval = setInterval(() => {
      progress += (100 / (totalSteps * 4));
      if (progress >= (currentStep + 1) * (100 / totalSteps)) {
        currentStep++;
        if (currentStep < totalSteps) {
          progressText.textContent = scanMessages[currentStep];
        }
      }
      progressBar.style.width = `${Math.min(progress, 100)}%`;

      if (progress >= 100) {
        clearInterval(interval);
      }
    }, 50);
  }

  function renderResults() {
    const q = document.getElementById('search').value.toLowerCase();
    const container = document.getElementById('results');
    container.innerHTML = '';
    const list = findings.filter(f => (currentFilter === 'all' || f.severity === currentFilter) && (f.title.toLowerCase().includes(q) || f.file.toLowerCase().includes(q)));
    list.forEach(f => {
      const el = document.createElement('div');
      el.className = 'finding';
      el.style.animationDelay = `${Math.random() * 0.5}s`;
      el.innerHTML = `
        <div class="left">
          <div class="sev ${f.severity.substring(0, 4)}">${f.severity.charAt(0).toUpperCase()}</div>
          <div>
            <div style="font-weight:700">${escapeHtml(f.title)}</div>
            <div class="meta">${escapeHtml(f.file)}:${f.line} &bullet; ${f.summary}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="pill ${f.severity}">${f.severity}</div>
          <button class="btn" onclick="openDetail(${f.id})">Details</button>
          <button class="btn" onclick="openSuggestFix(${f.id})">Suggest Fix</button>
        </div>`;
      container.appendChild(el);
    });
    updateRiskScore();
  }
function updateRiskScore() {
  const pills = document.querySelectorAll('.pill');
  let sum = 0;
  let count = 0;

  pills.forEach(pill => {
    const value = parseFloat(pill.textContent);
    if (!isNaN(value)) {
      sum += value;
      count++;
    }
  });

  if (count === 0) {
    document.getElementById('riskScore').textContent = "N/A";
    return;
  }

  const average = sum / count;
  const result = 100 - average;

  const scoreEl = document.getElementById('riskScore');
  if (scoreEl) {
    scoreEl.textContent = `${result.toFixed(2)}%`;
  }
}

  function setFilter(s) {
    currentFilter = s;
    document.querySelectorAll('.filters .btn').forEach(b => b.style.opacity = 0.5);
    document.querySelector(`.filters .btn[onclick="setFilter('${s}')"]`).style.opacity = 1;
    renderResults();
  }
  ['detailTitle','detailMeta','detailSeverity','detailSummary','detailCode'].forEach(id => {
    if (!document.getElementById(id)) {
        console.warn(`Missing element with id="${id}"`);
    }
    });

function openDetail(id) {
  const f = findings.find(x => x.id === id);
  if (!f) return;

  const titleEl = document.getElementById('detailTitle');
  const metaEl = document.getElementById('detailMeta');
  const severityEl = document.getElementById('detailSeverity');
  const summaryEl = document.getElementById('detailSummary');
  const codeEl = document.getElementById('detailCode');

  if (!titleEl || !metaEl || !severityEl || !summaryEl || !codeEl) {
    console.error('One or more detail panel elements are missing.');
    return;
  }

  titleEl.textContent = f.title;
  metaEl.textContent = `${f.file}:${f.line} • ${capitalize(f.severity)} • rule:custom`;
  severityEl.textContent = f.severity.toUpperCase();
  summaryEl.textContent = f.summary;
  codeEl.textContent = f.code;

  const overlay = document.getElementById('detailOverlay');
  const panel = document.getElementById('detailPanel');
  if (overlay && panel) {
    overlay.style.display = 'block';
    panel.classList.add('open');
    overlay.style.pointerEvents = 'auto';
  }
}

  function closeDetail() {
    const overlay = document.getElementById('detailOverlay');
    const panel = document.getElementById('detailPanel');
    panel.classList.remove('open');
    setTimeout(() => {
      overlay.style.display = 'none';
      overlay.style.pointerEvents = 'none';
    }, 400);
  }

  function openSuggestFix(id) {
    const f = findings.find(x => x.id === id);
    if (!f) return;
    document.getElementById('fixMeta').textContent = `${f.file}:${f.line} • ${capitalize(f.severity)} • rule:custom`;
    document.getElementById('suggestedFixCode').textContent = f.suggestedFix;
    const overlay = document.getElementById('suggestFixOverlay');
    overlay.style.display = 'block';
    const panel = document.getElementById('suggestFixPanel');
    panel.classList.add('open');
    overlay.style.pointerEvents = 'auto';
  }

  function closeSuggestFix() {
    const overlay = document.getElementById('suggestFixOverlay');
    const panel = document.getElementById('suggestFixPanel');
    panel.classList.remove('open');
    setTimeout(() => {
      overlay.style.display = 'none';
      overlay.style.pointerEvents = 'none';
    }, 400);
  }
  

  function applySuggested() {
    alert('Applied suggestion to workspace (placeholder)');
  }

  function copyFix() {
    document.execCommand('copy', false, document.getElementById('detailCode').textContent);
    alert('Copied fix to clipboard');
  }

  function copySuggestedFix() {
    document.execCommand('copy', false, document.getElementById('suggestedFixCode').textContent);
    alert('Copied suggested fix to clipboard!');
  }

  function exportJSON() {
    const blob = new Blob([JSON.stringify(findings, null, 2)], {
      type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'report.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function copySummary() {
    document.execCommand('copy', false, `Report — ${findings.length} findings`);
    alert('Copied summary to clipboard');
  }

  function restartScan() {
    location.reload();
  }

  function escapeHtml(s) {
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function capitalize(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  function showOutro() {
    alert('Share link (placeholder) — integrate your sharing flow here.');
  }

  // Accessibility: close detail on ESC
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeDetail();
      closeSuggestFix();
    }
  });
</script>

</body>
</html>
